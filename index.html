<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>QRè¦‹ç©ã‚¹ã‚­ãƒ£ãƒŠï¼ˆiOSæ‹¡å¼µç‰ˆ v4, å¤šå½¢å¼å¯¾å¿œï¼‰</title>
  <style>
    :root{ --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--line:#1f2937;--accent:#22c55e }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI",sans-serif}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0e1726 30%,#0b1220 100%);color:var(--text)}
    header{padding:20px 16px 8px;text-align:center}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;margin-top:6px}
    main{max-width:980px;margin:14px auto 140px;padding:0 12px;display:flex;flex-direction:column;gap:12px}
    .card{background:rgba(17,24,39,.7);backdrop-filter: blur(6px);border:1px solid var(--line);border-radius:14px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border:1px solid var(--line);background:#132037;color:var(--text);border-radius:10px;cursor:pointer}
    button.primary{background:linear-gradient(135deg,#2563eb,#22c55e);border-color:#1e293b}
    label{font-size:12px;color:var(--muted)}
    input[type="checkbox"]{transform:scale(1.1)}
    textarea{width:100%;min-height:96px;background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:820px){.kpi{grid-template-columns:1fr}}
    .kpi .item{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .label{font-size:11px;color:var(--muted)}
    .kpi .value{font-size:18px;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12.5px}
    th,td{border:1px solid var(--line);padding:8px;text-align:right}
    th{background:#0b1220;color:#cbd5e1}
    td.left, th.left{text-align:left}
    .muted{color:#93a1b3}
    .foot{position:fixed;left:0;right:0;bottom:0;background:#0b1426;color:#94a3b8;border-top:1px solid #1f2937;padding:12px 16px;font-size:.9rem;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .videoWrap{display:none;position:relative}
    video{width:100%;border-radius:12px;border:1px solid var(--line)}
    .overlay{position:absolute;inset:0;border:2px dashed rgba(255,255,255,.25);border-radius:12px;pointer-events:none}
    .small{font-size:11px;color:#93a1b3}
    .ok{color:#22c55e}
    .err{color:#f87171}
    .warn{color:#fbbf24}
    .pill{font-size:11px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0b1220}
    details{border:1px solid var(--line);border-radius:10px;padding:8px;background:#0b1220}
    details[open]{outline:1px solid #1f2d45}
    summary{cursor:pointer;color:#cbd5e1}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; word-break: break-all}
  </style>
  <script defer src="https://unpkg.com/@zxing/library@0.20.0"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
  <header>
    <h1>QRè¦‹ç©ã‚¹ã‚­ãƒ£ãƒŠï¼ˆiOSæ‹¡å¼µç‰ˆ v4ï¼‰</h1>
    <div class="sub">ãƒ©ã‚¤ãƒ– / ã‚¢ãƒ«ãƒãƒ  / ã‚«ãƒ¡ãƒ©æ’®å½±å¯¾å¿œã€‚<b>ZXingã®MultiFormatReader</b>ã§ QR / MicroQR / DataMatrix / Aztec / PDF417 ã‚’æ¢ç´¢ã€‚HTTPSæ¨å¥¨ã€‚</div>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <button id="scanBtn" class="primary">ğŸ¥ ãƒ©ã‚¤ãƒ–ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚«ãƒ¡ãƒ©æ˜ åƒï¼‰</button>
        <input id="filePickAlbum" type="file" accept="image/*" style="display:none"/>
        <input id="filePickCamera" type="file" accept="image/*;capture=camera" capture="environment" style="display:none"/>
        <button id="pickBtn">ğŸ–¼ å†™çœŸã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼ˆã‚¢ãƒ«ãƒãƒ ï¼‰</button>
        <button id="shootBtn">ğŸ“¸ ã‚«ãƒ¡ãƒ©ã§æ’®ã£ã¦èª­ã¿è¾¼ã‚€</button>
        <button id="parseTextBtn">âœï¸ JSONè²¼ã‚Šä»˜ã‘ â†’ è§£æ</button>
        <button id="demoBtn" class="pill">ğŸ”§ ãƒ‡ãƒ¢JSONã§è©¦ã™</button>
        <label style="display:flex;gap:6px;align-items:center;margin-left:auto">
          <input id="incMisc" type="checkbox" checked/>
          <span>OGãƒãƒ¼ã‚¸ãƒ³ã«<b>é›‘è²»ã‚’å«ã‚ã‚‹</b></span>
        </label>
      </div>

      <div class="videoWrap" id="videoWrap">
        <video id="video" playsinline muted></video>
        <div class="overlay"></div>
        <div class="row" style="margin-top:8px;justify-content:space-between">
          <div class="small" id="scanMode">èª­ã¿å–ã‚Šä¸­â€¦</div>
          <button id="stopBtn">åœæ­¢ / Stop</button>
        </div>
      </div>

      <div id="pasteArea" style="display:none;margin-top:8px">
        <label>QRã®JSONæ–‡å­—åˆ—ã‚’è²¼ã‚Šä»˜ã‘ / Paste JSON from QR</label>
        <textarea id="jsonText" placeholder='{"v":"OG-Quote-INPUT-v1","fxJpyIdr":"0x2A","products":[...]}'></textarea>
        <div class="row" style="justify-content:flex-end">
          <button id="parseBtn" class="primary">è§£æ / Parse</button>
        </div>
      </div>

      <div id="status" class="small muted" style="margin-top:6px">æº–å‚™å®Œäº† / Ready.</div>
      <div class="small warn" style="margin-top:6px">â€» ãƒ©ã‚¤ãƒ–/ã‚«ãƒ¡ãƒ©åˆ©ç”¨ã¯<b>HTTPS</b>å¿…é ˆã€‚è¨­å®š â†’ Safari â†’ ã‚«ãƒ¡ãƒ© ã‚’ã€Œè¨±å¯/ç¢ºèªã€ã«ã€‚HEICå†™çœŸã¯å¤±æ•—ã—ã‚„ã™ã„ã®ã§PNG/JPEGåŒ–ï¼ˆã‚¹ã‚¯ã‚·ãƒ§ç­‰ï¼‰æ¨å¥¨ã€‚</div>
    </section>

    <section class="card" id="diagCard" style="display:none">
      <details id="diagDetails">
        <summary>ğŸ§ª ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆæ¤œå‡ºçµæœã®ç”Ÿãƒ†ã‚­ã‚¹ãƒˆãªã©ï¼‰</summary>
        <div class="small" id="diagFormat"></div>
        <pre class="mono" id="diagRaw"></pre>
      </details>
    </section>

    <section class="card" id="results" style="display:none">
      <h3 style="margin:0 0 6px">é›†è¨ˆ / Totals</h3>
      <div class="kpi">
        <div class="item"><div class="label">å…¨ä½“ DPPï¼ˆç¨å‰, IDR / JPYï¼‰</div><div class="value" id="kpiDpp">-</div></div>
        <div class="item"><div class="label">å…¨ä½“ VATï¼ˆIDR / JPYï¼‰</div><div class="value" id="kpiVat">-</div></div>
        <div class="item"><div class="label">æœ€çµ‚ï¼ˆVATè¾¼, IDR / JPYï¼‰</div><div class="value" id="kpiGrand">-</div></div>
        <div class="item"><div class="label">å¹³å‡ï¼ˆDPP / VATè¾¼, IDR / JPY /å°ï¼‰</div><div class="value" id="kpiAvg">-</div></div>
        <div class="item"><div class="label">ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚¡ä¾¡æ ¼ï¼ˆåˆè¨ˆ / 1å°, IDR / JPYï¼‰</div><div class="value" id="kpiTransfer">-</div></div>
      </div>

      <h3 style="margin:10px 0 6px">å†…è¨³ï¼ˆPT.OG ç¨å‰è²©å£²ä¾¡æ ¼ã®æ§‹æˆï¼‰/ Breakdown</h3>
      <table>
        <thead><tr><th class="left">é …ç›® / Item</th><th>åˆè¨ˆ / Total</th><th>1å° / Per Unit</th><th>é€šè²¨</th></tr></thead>
        <tbody id="tbodyBreak"></tbody>
      </table>

      <h3 style="margin:10px 0 6px">è£½å“åˆ¥ã‚µãƒãƒªãƒ¼ / Per-Product Summary</h3>
      <table>
        <thead>
          <tr>
            <th class="left">è£½å“å</th><th>æ•°é‡</th>
            <th>åˆ©ç›Š (IDR / JPY)</th>
            <th>CIF (IDR / JPY)</th>
            <th>BM (IDR / JPY)</th>
            <th>PPh22 (IDR / JPY)</th>
            <th>é›‘è²» (IDR / JPY)</th>
            <th>ãƒãƒ¼ã‚¸ãƒ³ (IDR / JPY)</th>
            <th>DPP (IDR / JPY)</th>
            <th>VAT (IDR / JPY)</th>
            <th>æœ€çµ‚ (IDR / JPY)</th>
            <th>1å° DPP (IDR / JPY)</th>
            <th>1å° VAT (IDR / JPY)</th>
            <th>1å° æœ€çµ‚ (IDR / JPY)</th>
          </tr>
        </thead>
        <tbody id="tbodyProd"></tbody>
      </table>
      <div class="small" style="margin-top:8px">Parser: <b>OG-Quote-INPUT-v1</b>ï¼ˆHEX 0x?? OKï¼‰</div>
    </section>
  </main>

  <div class="foot">
    <span>Copyright 2025 KONGO INDUSTRIES CO LTD. Created by H.TAKASHIMA</span>
    <span class="small">QR â†’ å…¥åŠ›JSON â†’ åŒè¨ˆç®— / Scan â†’ Parse â†’ Compute</span>
  </div>

  <script>
    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const fmtJPY = n => new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}).format(n||0);
    const fmtIDR = n => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n||0);
    const toNum = (x)=>{
      if(x==null) return 0;
      if(typeof x === 'number') return x;
      if(typeof x === 'string'){
        const s = x.trim();
        if(/^0x[0-9a-fA-F]+$/.test(s)) return parseInt(s,16);
        const cleaned = s.replace(/[_ ,]/g,'');
        if(/^[0-9]+(\\.[0-9]+)?$/.test(cleaned)) return +cleaned;
      }
      return +x || 0;
    };
    const pctToRatio = p => toNum(p)/100;
    const pairFromIdr = (idr, fx)=>{
      const jpy = fx>0 ? (idr/fx) : 0;
      return fmtIDR(idr) + " / " + fmtJPY(jpy);
    };

    // ===== Core compute =====
    function computeFromPayload(qr, includeMiscDefault=true){
      const fx = toNum(qr.fxJpyIdr);
      const containerCount = toNum(qr.containerCount);
      const freightPerContainerJPY = toNum(qr.freightPerContainerJPY);
      const pph22Pct = pctToRatio(qr.pph22Pct);
      const ogMarginPct = pctToRatio(qr.ogMarginPct);
      const vatPct = pctToRatio(qr.vatPct);
      const incMiscFlag = (typeof qr.ogMarginIncludeMisc === 'boolean') ? qr.ogMarginIncludeMisc : includeMiscDefault;

      const products = (qr.products||[]).map(p=>{
        const unitJPY = toNum(p.unitJPY);
        const qty = toNum(p.qty);
        const marginPct = pctToRatio(p.marginPct);
        const bmPct = pctToRatio(p.bmPct);
        const miscIdrPerUnit = toNum(p.miscIdrPerUnit);
        const unitWithMarginJPY = unitJPY * (1 + marginPct);
        const subtotalJpy = unitWithMarginJPY * qty;
        return { name: p.name||"", unitJPY, qty, marginPct, bmPct, miscIdrPerUnit, unitWithMarginJPY, subtotalJpy };
      }).filter(p=>p.qty>0);

      const totalQty = products.reduce((a,b)=>a+b.qty,0);
      const productsSubtotalJpy = products.reduce((a,b)=>a+b.subtotalJpy,0);
      const freightJPY = containerCount * freightPerContainerJPY;
      const transferTotalJPY = productsSubtotalJpy + freightJPY;
      const transferPerUnitJPY = totalQty>0 ? transferTotalJPY/totalQty : 0;

      const cifTotalIDR = transferTotalJPY * fx;
      const cifPerUnitIDR = totalQty>0 ? transferPerUnitJPY * fx : 0;

      const prodAlloc = products.map(p=>{
        const ratio = productsSubtotalJpy>0 ? (p.subtotalJpy / productsSubtotalJpy) : 0;
        const cifAllocIdr = ratio * cifTotalIDR;
        const bmIdr = cifAllocIdr * p.bmPct;
        return { ...p, ratio, cifAllocIdr, bmIdr };
      });

      const bmTotalIDR = prodAlloc.reduce((a,b)=>a+b.bmIdr,0);
      const miscTotalIDR = prodAlloc.reduce((a,b)=>a + (b.miscIdrPerUnit * b.qty), 0);
      const pph22IDR = (cifTotalIDR + bmTotalIDR) * pph22Pct;

      const baseNoMiscIDR = cifTotalIDR + bmTotalIDR + pph22IDR;
      const baseForMarginIDR = incMiscFlag ? (baseNoMiscIDR + miscTotalIDR) : baseNoMiscIDR;

      const ogMarginIDR = baseForMarginIDR * ogMarginPct;
      const dppIDR = baseNoMiscIDR + ogMarginIDR + miscTotalIDR;
      const vatIDR = dppIDR * vatPct;
      const finalWithVATTotalIDR = dppIDR + vatIDR;
      const finalPerUnitPreVAT = totalQty>0 ? dppIDR/totalQty : 0;
      const finalPerUnitWithVAT = totalQty>0 ? finalWithVATTotalIDR/totalQty : 0;

      const profitTotalIdr = prodAlloc.reduce((a,p)=>a + Math.max(0,(p.unitWithMarginJPY - p.unitJPY))*p.qty*fx,0);
      const profitPerUnitIdr = totalQty>0 ? profitTotalIdr/totalQty : 0;

      const perProducts = prodAlloc.map(p=>{
        const profitJpy = Math.max(0,(p.unitWithMarginJPY - p.unitJPY)) * p.qty;
        const profitIdr = profitJpy * fx;
        const pph22Idr = (p.cifAllocIdr + p.bmIdr) * pph22Pct;
        const miscIdrProd = p.miscIdrPerUnit * p.qty;
        const baseNoMiscIdr_p = p.cifAllocIdr + p.bmIdr + pph22Idr;
        const baseForMarginIdr_p = incMiscFlag ? (baseNoMiscIdr_p + miscIdrProd) : baseNoMiscIdr_p;
        const marginIdr_p = baseForMarginIdr_p * ogMarginPct;
        const dppIdr_p = baseNoMiscIdr_p + marginIdr_p + miscIdrProd;
        const vatIdr_p = dppIdr_p * vatPct;
        const finalIdr_p = dppIdr_p + vatIdr_p;
        const dppPerUnitIdr_p = p.qty>0 ? dppIdr_p/p.qty : 0;
        const vatPerUnitIdr_p = p.qty>0 ? vatIdr_p/p.qty : 0;
        const finalPerUnitIdr_p = p.qty>0 ? finalIdr_p/p.qty : 0;
        return {
          name:p.name, qty:p.qty,
          profitIdr, cifIdr:p.cifAllocIdr, bmIdr:p.bmIdr, pph22Idr, miscIdr:miscIdrProd,
          marginIdr:marginIdr_p, dppIdr:dppIdr_p, vatIdr:vatIdr_p, finalIdr:finalIdr_p,
          dppPerUnitIdr:dppPerUnitIdr_p, vatPerUnitIdr:vatPerUnitIdr_p, finalPerUnitIdr:finalPerUnitIdr_p
        };
      });

      return { meta:{fx,totalQty,cifTotalIDR,cifPerUnitIDR}, totals:{dppIDR,vatIDR,finalWithVATTotalIDR,profitTotalIdr,profitPerUnitIdr,bmTotalIDR,miscTotalIDR,pph22IDR,ogMarginIDR,finalPerUnitPreVAT,finalPerUnitWithVAT}, perProducts };
    }

    function render(r){
      const fx = toNum(r.meta.fx);
      const pair = (v)=> pairFromIdr(v, fx);
      $("#kpiDpp").textContent   = pair(r.totals.dppIDR);
      $("#kpiVat").textContent   = pair(r.totals.vatIDR);
      $("#kpiGrand").textContent = pair(r.totals.finalWithVATTotalIDR);
      $("#kpiAvg").innerHTML     = pair(r.totals.finalPerUnitPreVAT)+ "<br/>" + pair(r.totals.finalPerUnitWithVAT);
      $("#kpiTransfer").innerHTML= pair(r.meta.cifTotalIDR)+ "<br/>" + pair(r.meta.cifPerUnitIDR);

      const rows = [
        {n:'åˆ©ç›Š / Profit', t:r.totals.profitTotalIdr, u:r.totals.profitPerUnitIdr},
        {n:'CIFï¼ˆè£½å“å°è¨ˆ+é‹è³ƒï¼‰/ CIF', t:r.meta.cifTotalIDR, u:r.meta.cifPerUnitIDR},
        {n:'BMï¼ˆé–¢ç¨ åˆç®—ï¼‰/ Duty', t:r.totals.bmTotalIDR, u:(r.meta.totalQty? r.totals.bmTotalIDR/r.meta.totalQty : 0)},
        {n:'PPh22 Import', t:r.totals.pph22IDR, u:(r.meta.totalQty? r.totals.pph22IDR/r.meta.totalQty : 0)},
        {n:'é›‘è²» / Misc', t:r.totals.miscTotalIDR, u:(r.meta.totalQty? r.totals.miscTotalIDR/r.meta.totalQty : 0)},
        {n:'OGãƒãƒ¼ã‚¸ãƒ³ / OG Margin', t:r.totals.ogMarginIDR, u:(r.meta.totalQty? r.totals.ogMarginIDR/r.meta.totalQty : 0)},
        {n:'DPPï¼ˆç¨å‰ï¼‰/ DPP', t:r.totals.dppIDR, u:(r.meta.totalQty? r.totals.dppIDR/r.meta.totalQty : 0)},
        {n:'VAT', t:r.totals.vatIDR, u:(r.meta.totalQty? r.totals.vatIDR/r.meta.totalQty : 0)},
        {n:'æœ€çµ‚ï¼ˆVATè¾¼ï¼‰/ Grand Total', t:r.totals.finalWithVATTotalIDR, u:(r.meta.totalQty? r.totals.finalWithVATTotalIDR/r.meta.totalQty : 0)}
      ];
      const tb = $("#tbodyBreak"); tb.innerHTML="";
      rows.forEach(rw=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="left">${rw.n}</td><td>${pair(rw.t)}</td><td>${pair(rw.u)}</td><td>IDR / JPY</td>`;
        tb.appendChild(tr);
      });

      const tp = $("#tbodyProd"); tp.innerHTML="";
      r.perProducts.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="left">${p.name}</td>
          <td>${p.qty.toLocaleString('ja-JP')}</td>
          <td>${pair(p.profitIdr)}</td>
          <td>${pair(p.cifIdr)}</td>
          <td>${pair(p.bmIdr)}</td>
          <td>${pair(p.pph22Idr)}</td>
          <td>${pair(p.miscIdr)}</td>
          <td>${pair(p.marginIdr)}</td>
          <td>${pair(p.dppIdr)}</td>
          <td>${pair(p.vatIdr)}</td>
          <td>${pair(p.finalIdr)}</td>
          <td>${pair(p.dppPerUnitIdr)}</td>
          <td>${pair(p.vatPerUnitIdr)}</td>
          <td>${pair(p.finalPerUnitIdr)}</td>
        `;
        tp.appendChild(tr);
      });

      $("#results").style.display = "";
      $("#status").innerHTML = '<span class="ok">è¨ˆç®—å®Œäº† / Computed.</span>';
    }

    // ===== DIAGNOSTICS =====
    function showDiag(format, raw){
      $("#diagFormat").textContent = "æ¤œå‡ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: " + (format || "ä¸æ˜");
      $("#diagRaw").textContent = raw || "";
      $("#diagCard").style.display = "";
    }

    // ===== Live scan (getUserMedia) with multi-format ZXing =====
    let stream = null, scanning = false, detector=null, zxingQR=null, zxingMulti=null;
    async function ensureDetector(){
      if('BarcodeDetector' in window){
        try{
          const fmts = await (window.BarcodeDetector?.getSupportedFormats?.() || []);
          const use = fmts.filter(f=>['qr_code','micro_qr_code','aztec','data_matrix','pdf417'].includes(f));
          if(use.length){ detector = new window.BarcodeDetector({formats:use}); return true; }
        }catch(e){}
      }
      return false;
    }
    function ensureZXingReaders(){
      if(!window.ZXing) return false;
      try{
        if(!zxingQR){
          zxingQR = new ZXing.BrowserQRCodeReader();
        }
      }catch(e){}
      try{
        if(!zxingMulti){
          const hints = new Map();
          hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
            ZXing.BarcodeFormat.QR_CODE,
            ZXing.BarcodeFormat.DATA_MATRIX,
            ZXing.BarcodeFormat.AZTEC,
            ZXing.BarcodeFormat.PDF_417,
          ]);
          zxingMulti = new ZXing.BrowserMultiFormatReader(hints);
        }
      }catch(e){}
      return !!(zxingQR || zxingMulti);
    }
    const hasJsQR = ()=> !!window.jsQR;

    async function startScan(){
      $("#status").textContent = "ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­â€¦";
      const hasBD = await ensureDetector();
      const hasZX = ensureZXingReaders();
      const hasJQ = hasJsQR();
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      }catch(err){
        $("#status").innerHTML = '<span class="err">ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚HTTPS/æ¨©é™ï¼ˆè¨­å®šâ†’Safariâ†’ã‚«ãƒ¡ãƒ©ï¼‰ã‚’ç¢ºèªã€‚</span>';
        return;
      }
      const video = $("#video");
      video.srcObject = stream; await video.play();
      $("#videoWrap").style.display = ""; scanning = true;
      $("#scanMode").textContent = hasBD? "BarcodeDetector" : (hasZX? "ZXing(Multi)" : (hasJQ? "jsQR" : "å¾…æ©Ÿä¸­"));
      if(hasBD) scanWithBarcodeDetector(video);
      else if(hasZX) scanWithZXing(video);
      else if(hasJQ) scanWithJsQR(video);
      else setTimeout(()=>{
        if(ensureZXingReaders()) scanWithZXing(video);
        else if(hasJsQR()) scanWithJsQR(video);
        else $("#status").innerHTML = '<span class="err">è§£æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚</span>';
      },700);
    }

    async function scanWithBarcodeDetector(video){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const tick = async()=>{
        if(!scanning) return;
        if(video.readyState === video.HAVE_ENOUGH_DATA){
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          try{
            const found = await detector.detect(canvas);
            if(found && found.length){
              stopScan();
              const code = found[0];
              showDiag(code.format || "BarcodeDetector", code.rawValue || "");
              handleRaw(code.rawValue || "");
              return;
            }
          }catch(e){}
        }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }
    function scanWithZXing(video){
      const reader = zxingMulti || zxingQR;
      if(!reader){ $("#status").innerHTML = '<span class="err">ZXingæœªåˆæœŸåŒ–ã€‚</span>'; return; }
      reader.decodeFromVideoDevice({facingMode:"environment"}, video, (result, err, controls)=>{
        if(!scanning){ try{controls?.stop();}catch{} return; }
        if(result){
          stopScan(); try{controls?.stop();}catch{}
          showDiag((result.getBarcodeFormat && String(result.getBarcodeFormat())) || "ZXing", result.getText());
          handleRaw(result.getText());
        }
      });
    }
    function scanWithJsQR(video){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const tick = ()=>{
        if(!scanning) return;
        if(video.readyState === video.HAVE_ENOUGH_DATA){
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          try{
            const img = ctx.getImageData(0,0,canvas.width,canvas.height);
            const res = window.jsQR(img.data, img.width, img.height, { inversionAttempts:"attemptBoth" });
            if(res && res.data){
              stopScan();
              showDiag("jsQR", res.data);
              handleRaw(res.data);
              return;
            }
          }catch(e){}
        }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);
    }
    function stopScan(){
      scanning = false; $("#videoWrap").style.display = "none";
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      try{ zxingQR?.reset(); zxingMulti?.reset(); }catch(e){}
    }

    // ===== Handle decoded string (any format) =====
    function normalizeMaybeJSON(text){
      if(!text) return text;
      const idx = text.indexOf("{");
      if(idx >= 0){
        const trimmed = text.slice(idx);
        const last = trimmed.lastIndexOf("}");
        if(last > 0){
          return trimmed.slice(0, last+1);
        }
      }
      return text;
    }
    function handleRaw(rawText){
      const maybe = normalizeMaybeJSON(rawText.trim());
      try{
        const obj = JSON.parse(maybe);
        const inc = $("#incMisc").checked;
        render(computeFromPayload(obj, inc));
        $("#status").innerHTML = '<span class="ok">è§£ææˆåŠŸï¼šJSONèªè­˜ã§ãã¾ã—ãŸã€‚</span>';
      }catch(e){
        $("#status").innerHTML = '<span class="warn">QRã¯æ¤œå‡ºã—ã¾ã—ãŸãŒã€JSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‹ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</span>';
      }
    }

    // ===== Image pipeline with multi-scale attempts =====
    async function pickFromPhoto(file){
      if(!file) return;
      $("#status").textContent = "ç”»åƒã‹ã‚‰è§£æä¸­â€¦";
      let bitmap = null;
      try{ if('createImageBitmap' in window){ bitmap = await createImageBitmap(file); } }catch(e){}
      if(bitmap){
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width; canvas.height = bitmap.height;
        const ctx = canvas.getContext('2d'); ctx.drawImage(bitmap,0,0);
        const ok = await tryAllDecodersOnCanvas(canvas);
        if(ok) return;
      }
      const img = new Image();
      img.onload = async ()=>{
        const baseCanvas = document.createElement('canvas');
        baseCanvas.width = img.naturalWidth; baseCanvas.height = img.naturalHeight;
        const bctx = baseCanvas.getContext('2d'); bctx.drawImage(img,0,0);
        const ok = await tryAllDecodersOnCanvas(baseCanvas);
        if(ok) return;
        const scales = [0.5, 0.75, 1.25, 1.5, 2];
        for(const s of scales){
          const c = document.createElement('canvas');
          c.width = Math.max(64, Math.floor(baseCanvas.width * s));
          c.height = Math.max(64, Math.floor(baseCanvas.height * s));
          const ctx = c.getContext('2d');
          ctx.imageSmoothingEnabled = s>1;
          ctx.drawImage(baseCanvas, 0, 0, c.width, c.height);
          const ok2 = await tryAllDecodersOnCanvas(c);
          if(ok2) return;
        }
        $("#status").innerHTML = '<span class="err">QRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚µã‚¤ã‚º/ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ/ä½™ç™½/ãƒ”ãƒ³ãƒˆã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚</span>';
      };
      img.onerror = ()=> $("#status").innerHTML = '<span class="err">ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆHEICç­‰ã®å¯èƒ½æ€§ï¼‰ã€‚PNG/JPEGã«å¤‰æ›ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</span>';
      img.src = URL.createObjectURL(file);
    }

    async function tryAllDecodersOnCanvas(canvas){
      if(await ensureDetector()){
        try{
          const found = await detector.detect(canvas);
          if(found && found.length){
            const code = found[0];
            showDiag(code.format || "BarcodeDetector", code.rawValue || "");
            handleRaw(code.rawValue || "");
            return true;
          }
        }catch(e){}
      }
      if(ensureZXingReaders()){
        try{
          const url = canvas.toDataURL("image/png");
          if(zxingMulti && zxingMulti.decodeFromImageUrl){
            const res = await zxingMulti.decodeFromImageUrl(url);
            if(res){
              showDiag("ZXing MultiFormat", res.getText());
              handleRaw(res.getText());
              return true;
            }
          }
        }catch(e){}
        try{
          if(zxingQR && zxingQR.decodeFromImage){
            const res2 = await zxingQR.decodeFromImage(canvas);
            if(res2){
              showDiag("ZXing QR", res2.getText());
              handleRaw(res2.getText());
              return true;
            }
          }
        }catch(e){}
      }
      if(hasJsQR()){
        try{
          const ctx = canvas.getContext('2d');
          const id = ctx.getImageData(0,0,canvas.width,canvas.height);
          const r = window.jsQR(id.data, id.width, id.height, { inversionAttempts:"attemptBoth" });
          if(r && r.data){
            showDiag("jsQR", r.data);
            handleRaw(r.data);
            return true;
          }
        }catch(e){}
      }
      return false;
    }

    // ===== Events =====
    $("#scanBtn").addEventListener('click', ()=>{
      $("#diagCard").style.display = "none";
      startScan();
    });
    $("#stopBtn").addEventListener('click', ()=>{ $("#diagCard").style.display = "none"; stopScan(); });
    $("#pickBtn").addEventListener('click', ()=> { $("#diagCard").style.display = "none"; $("#filePickAlbum").click(); });
    $("#shootBtn").addEventListener('click', ()=> { $("#diagCard").style.display = "none"; $("#filePickCamera").click(); });
    $("#filePickAlbum").addEventListener('change', e=> pickFromPhoto(e.target.files?.[0]));
    $("#filePickCamera").addEventListener('change', e=> pickFromPhoto(e.target.files?.[0]));
    $("#parseTextBtn").addEventListener('click', ()=> { $("#pasteArea").style.display=""; });
    $("#parseBtn").addEventListener('click', ()=>{
      $("#diagCard").style.display = "none";
      try{
        const obj = JSON.parse($("#jsonText").value.trim());
        const inc = $("#incMisc").checked;
        render(computeFromPayload(obj, inc));
        $("#status").innerHTML = '<span class="ok">è²¼ã‚Šä»˜ã‘JSONã‚’è§£æã—ã¾ã—ãŸã€‚</span>';
      }catch{ $("#status").innerHTML = '<span class="err">JSONè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚</span>'; }
    });

    // Demo JSON
    const demo = { v:"OG-Quote-INPUT-v1", fxJpyIdr:"0x2EE0", containerCount:"0x1", freightPerContainerJPY:"0x186A0", pph22Pct:"0x19", ogMarginPct:"0x14", vatPct:"0x0B", ogMarginIncludeMisc:true, products:[ {name:"Overhead Door A", unitJPY:"0x017D7840", qty:"0x0A", marginPct:"0x0A", bmPct:"0x0A", miscIdrPerUnit:"0x0"} ] };
    $("#demoBtn").addEventListener('click', ()=>{
      $("#diagCard").style.display = "none";
      const inc = $("#incMisc").checked;
      render(computeFromPayload(demo, inc));
      $("#status").innerHTML = '<span class="ok">ãƒ‡ãƒ¢JSONã§è¨ˆç®—ã—ã¾ã—ãŸã€‚</span>';
    });
  </script>
</body>
</html>
